{{define "Mission"}}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Missões</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

<div class="mission-container">
    <!-- Título da Página -->
    <h1>Missões</h1>


    <!-- Formulário para Criar ou Editar Missão -->
    {{if .ShowFormMission}}
    <div class="mission-form">
        <h2>{{if .IsEdit}}Editar Missão{{else}}Criar Nova Missão{{end}}</h2>
        <form id="missionForm" action="{{if .IsEdit}}/update-mission{{else}}/insert-mission{{end}}" method="post">
            {{if .IsEdit}}<input type="hidden" name="id" value="{{.Mission.ID}}">{{end}}
            <label>Nome Missão:</label>
            <input type="text" name="nome_missao" value="{{.Mission.NomeMissao}}" required>
            <label>Descrição:</label>
            <textarea name="descricao" required>{{.Mission.Descricao}}</textarea>
            <label>Nível de Dificuldade:</label>
            <input type="number" name="nivel_dificuldade" value="{{.Mission.NivelDificuldade}}" required>
            <label>Herói Envolvido:</label>
            <select name="heroi_envolvido" required>
                {{range .Heroes}}
                <option value="{{.ID}}" {{if eq .ID .Mission.HeroiEnvolvido}}selected{{end}}>{{.NomeHeroi}}</option>
                {{end}}
            </select>
            <button type="submit" class="submit-button">{{if .IsEdit}}Atualizar{{else}}Criar{{end}}</button>
        </form>
    </div>
    {{end}}

    <!-- Listagem de Missões -->
{{if .ShowListMissions}}
<div class="mission-list">
    <h2>Lista de Missões</h2>
    <table class="mission-table">
        <tr>
            <th>ID</th>
            <th>Nome Missão</th>
            <th>Nível de Dificuldade</th>
            <th>Ações</th>
        </tr>
        {{range .Missions}}
        <tr>
            <td>{{.ID}}</td>
            <td>{{.NomeMissao}}</td>
            <td>{{.NivelDificuldade}}</td>
            <td>
                <button type="button" class="action-link" onclick="showEditRow('{{.ID}}')">Editar</button>
                <form onsubmit="deleteMission(event, '{{.ID}}')" style="display:inline;">
                    <input type="hidden" name="id" value="{{.ID}}">
                    <button type="submit" class="action-link">Excluir</button>
                </form>
                
                <!-- Linha de edição da missão -->
                <tr id="edit-row-{{.ID}}" class="edit-row">
                    <form onsubmit="updateMission(event, '{{.ID}}')">
                        <td>{{.ID}}</td>
                        <td><input type="text" name="nome_missao" value="{{.NomeMissao}}"></td>
                        <td><input type="text" name="nivel_dificuldade" value="{{.NivelDificuldade}}"></td>
                        <td>
                            <input type="hidden" name="id" value="{{.ID}}">
                            <button type="submit" class="action-link">Confirmar</button>
                            <button type="button" class="action-link" onclick="hideEditRow('{{.ID}}')">Cancelar</button>
                        </td>
                    </form>
                </tr>
                </form>
        </tr>
        {{end}}
    </table>

<script>
function showEditRow(id) {
    document.getElementById('edit-row-' + id).style.display = 'table-row';
}

function hideEditRow(id) {
    document.getElementById('edit-row-' + id).style.display = 'none';
}

document.getElementById("missionForm").addEventListener("submit", function(event) {
    event.preventDefault();

    const formData = new FormData(this);
    const actionUrl = this.getAttribute("action");

    fetch(actionUrl, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateMissionTable(data.mission);
        } else {
            alert("Erro: " + data.message);
        }
    })
    .catch(error => console.error("Erro na requisição:", error));
});

function updateMissionTable(mission) {
    const missionTable = document.querySelector(".mission-table tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${mission.ID}</td>
        <td>${mission.MissionName}</td>
        <td>${mission.Dificulty}</td>
        <td>
            <button type="button" class="action-link" onclick="showEditRow('${mission.ID}')">Editar</button>
            <form method="post" action="/delete-mission" style="display:inline;">
                <input type="hidden" name="id" value="${mission.ID}">
                <button type="submit" class="action-link">Excluir</button>
            </form>
        </td>
    `;

    missionTable.appendChild(row);
}
</script>
</div>
{{end}}

    <a href="/" class="back-link">Voltar</a>
</div>

</body>
</html>
{{end}}
